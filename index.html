<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Duong Thai Bao | Developer</title>
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
		<script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>

		<script>
			AFRAME.registerComponent("player", {
				schema: {
					name: { type: "string", default: "player 1" },
					hp: { type: "number", default: 100 },
				},
				init: function () {
					console.info("----- INIT -----");
					console.log(this.data);
					const target = this.el;

					this.el.addEventListener("hit", (data) => {
						console.info("----- HIT EVENT -----");
						const currentHP = this.el.getAttribute("player").hp;
						const newHP = Math.max(currentHP - data.detail, 0);
						console.log(`ðŸ©¸ HP: ${currentHP} â†’ ${newHP}`);
						this.el.setAttribute("player", { hp: newHP });
					});
				},
				update: function (oldData) {
					console.info("----- UPDATE -----");
					console.log("Old:", oldData);
					console.log("New:", this.data);

					if (this.data.hp == 0) {
						if (this.el.components["static-body"]) {
							console.log("CÃ³ static-body");
							console.log(this.el.components);
							setTimeout(() => {
								this.el.removeAttribute("static-body");
								console.log("Remove cho báº¯n xuyÃªn");
							}, 0);
						}
						this.el.setAttribute("animation", {
							property: "scale",
							to: "0 0 0",
							dur: 300,
							easing: "easeOutQuad",
						});
						setTimeout(() => {
							this.el.parentNode.removeChild(this.el);
						}, 300);
					}
				},
				remove: function () {
					const target = document.createElement("a-box");
					target.setAttribute("id", "target");
					target.setAttribute("player", "");
					target.setAttribute(
						"dynamic-body",
						"shape: sphere; mass: 5000; linearDamping: 0; angularDamping: 0;"
					);
					const randomX = Math.random() * 10 - 1;
					target.setAttribute("position", randomX + " 4 -10");
					target.setAttribute("depth", "1");
					target.setAttribute("height", "2");
					target.setAttribute("width", "2");
					target.setAttribute("color", "tomato");

					document.querySelector("#scene").appendChild(target);
				},
			});
		</script>
	</head>
	<body>
		<a-scene physics="debug: false" id="scene">
			<!-- Camera ngÆ°á»i chÆ¡i -->
			<a-entity
				id="player_camera"
				camera
				position="0 1.6 0"
				look-controls="pointerLockEnabled: true"
				simple-movement
                gravity-movement
			>
				<a-cursor></a-cursor>
			</a-entity>

			<!-- Target Ä‘á»ƒ test va cháº¡m -->
			<a-box
				id="target"
				player="hp: 100"
				position="0 1 -10"
				depth="1"
				height="2"
				width="2"
				color="tomato"
				static-body
			></a-box>

			<!-- Máº·t Ä‘áº¥t -->
			<a-plane
				rotation="-90 0 0"
				width="30"
				height="30"
				color="#7BC8A4"
				static-body
			></a-plane>

			<!-- Ãnh sÃ¡ng -->
			<a-light type="ambient" color="#fff"></a-light>
			<a-light
				type="directional"
				position="2 4 1"
				intensity="0.5"
			></a-light>
		</a-scene>

		<script>
			let velocity = new THREE.Vector3();
			let direction = new THREE.Vector3();
			const speed = 5;
			const rig = document.querySelector("#player_camera");
			const camera = document.querySelector("#player_camera");
			const keys = {};

			document.addEventListener("keydown", (e) => (keys[e.code] = true));
			document.addEventListener("keyup", (e) => (keys[e.code] = false));

			AFRAME.registerComponent("simple-movement", {
				init: function () {
					this.raycaster = new THREE.Raycaster();
				},
				tick: function (time, deltaTime) {
					deltaTime = deltaTime / 1000;
					direction.set(0, 0, 0);

					if (keys["KeyW"]) direction.z -= 1;
					if (keys["KeyS"]) direction.z += 1;
					if (keys["KeyA"]) direction.x -= 1;
					if (keys["KeyD"]) direction.x += 1;

					if (direction.length() > 0) {
						direction.normalize();

						const dir = camera.object3D.getWorldDirection(
							new THREE.Vector3()
						);
						const move = new THREE.Vector3(
							dir.x * direction.z + dir.z * direction.x,
							0,
							dir.z * direction.z - dir.x * direction.x
						).normalize();

						// Raycast check
						const from = rig.object3D.position.clone();
						this.raycaster.set(from, move);
						const intersects = this.raycaster.intersectObjects(
							Array.from(document.querySelectorAll("a-box")).map(
								(box) => box.object3D
							),
							true
						);

						const blockDistance = 1.2; // khoáº£ng cÃ¡ch gáº§n quÃ¡ thÃ¬ block
						if (
							intersects.length === 0 ||
							intersects[0].distance > blockDistance
						) {
							rig.object3D.position.addScaledVector(
								move,
								speed * deltaTime
							);
						}
					}
				},
			});

			rig.setAttribute("simple-movement", "");
		</script>

		<script>
			AFRAME.registerComponent("gravity-movement", {
				init: function () {
					this.velocityY = 0;
					this.gravity = -9.8; // m/sÂ²
					this.grounded = false;
				},
				tick: function (time, deltaTime) {
					const dt = deltaTime / 1000;
					const pos = this.el.object3D.position;

					// Raycast tá»« chÃ¢n player xuá»‘ng
					const downRay = new THREE.Raycaster(
						new THREE.Vector3(pos.x, pos.y, pos.z),
						new THREE.Vector3(0, -1, 0)
					);

					const intersects = downRay.intersectObjects(
						Array.from(
							document.querySelectorAll("a-plane, a-box")
						).map((el) => el.object3D),
						true
					);

					if (intersects.length > 0 && intersects[0].distance < 1.6) {
						// Äang Ä‘á»©ng trÃªn máº·t Ä‘áº¥t
						this.velocityY = 0;
						this.grounded = true;
					} else {
						// RÆ¡i xuá»‘ng
						this.velocityY += this.gravity * dt;
						pos.y += this.velocityY * dt;
						this.el.object3D.position.y = pos.y;
						this.grounded = false;
					}
				},
			});
		</script>

		<script>
			document.addEventListener("keydown", (e) => {
				if (e.code === "Space") {
					const scene = document.querySelector("a-scene");
					const camera = document.querySelector("#player_camera");

					// Táº¡o viÃªn Ä‘áº¡n
					const bullet = document.createElement("a-sphere");
					bullet.setAttribute("radius", 0.1);
					bullet.setAttribute("color", "yellow");
					bullet.setAttribute("dynamic-body", "");

					// Láº¥y vá»‹ trÃ­ vÃ  hÆ°á»›ng nhÃ¬n tá»« camera
					const camPos = new THREE.Vector3();
					const camDir = new THREE.Vector3();
					camera.object3D.getWorldPosition(camPos); // Tá»a Ä‘á»™ hiá»‡n táº¡i cá»§a camera
					camera.object3D.getWorldDirection(camDir); // HÆ°á»›ng nhÃ¬n

					// âœ… Physics cÃ i Ä‘áº·t chuáº©n: khÃ´ng quay, khÃ´ng cháº­m, khÃ´ng rÆ¡i
					// dynamic-body: LÃ  váº­t thá»ƒ chuyá»ƒn Ä‘á»™ng
					// mass: 1: Trá»ng lÆ°á»£ng (cÃ³ thá»ƒ tÄƒng)
					// linearDamping: 0: KhÃ´ng lÃ m cháº­m khi bay
					// angularDamping: 0: KhÃ´ng xoay tÃ o lao, giá»¯ hÆ°á»›ng chuáº©n
					bullet.setAttribute(
						"dynamic-body",
						"shape: sphere; mass: 1; linearDamping: 0; angularDamping: 0;"
					);

					bullet.setAttribute(
						"position",
						`${camPos.x} ${camPos.y} ${camPos.z}`
					); //GÃ¡n vá»‹ trÃ­ ban Ä‘áº§u cho viÃªn Ä‘áº¡n Ä‘Ãºng nÆ¡i ngÆ°á»i chÆ¡i Ä‘ang Ä‘á»©ng

					scene.appendChild(bullet);

					// Ãp lá»±c Ä‘áº©y viÃªn Ä‘áº¡n bay
					bullet.addEventListener("body-loaded", () => {
						const force = camDir.multiplyScalar(-7000);
						bullet.body.applyForce(
							new CANNON.Vec3(force.x, force.y, force.z),
							new CANNON.Vec3().copy(bullet.body.position)
						);
					});

					bullet.addEventListener("collide", (e) => {
						// console.log("Va cháº¡m: ", e.detail.body.el.id);
						const target = e.detail.body.el;
						if (target && target.components.player) {
							console.log("ðŸ’¥ Player collide emit...");
							target.emit("hit", 25);
						}
					});
				}
			});
		</script>
	</body>
</html>
